<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Synaptics.Systems — AML/CTF Core (Anchored)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#050716;
      --panel:#0b0f24;
      --panel-2:#0e1430;
      --border:#1b2340;
      --border-soft:#222c52;
      --accent:#12f0ff;
      --accent-2:#8a7dff;
      --accent-soft:rgba(18,240,255,.12);
      --text:#f5f7ff;
      --muted:#a1a7c4;
      --good:#3ce57c;
      --warn:#ffc857;
      --bad:#ff4d6d;
      --chip:#151a30;
      --chip-b:#2a355a;
      --shadow:0 10px 30px rgba(0,0,0,.45);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:
        radial-gradient(1200px 700px at 80% -10%, rgba(18,240,255,.12), transparent 55%),
        radial-gradient(1000px 600px at 0% 100%, rgba(138,125,255,.12), transparent 50%),
        var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial,sans-serif;
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(8px);
      background: rgba(5,7,22,.85);
      border-bottom:1px solid var(--border);
    }
    nav{display:flex; gap:8px; flex-wrap:wrap; margin-left:auto;}
    nav a{
      color:var(--text); text-decoration:none;
      border:1px solid var(--border); background:rgba(255,255,255,.04);
      padding:6px 10px; border-radius:10px; font-weight:700; font-size:12px;
      transition:.16s ease;
    }
    nav a:hover{border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-soft);}
    .wrap{max-width:1200px; margin:0 auto; padding:18px;}
    .brand{
      display:flex; align-items:center; gap:14px;
    }
    .logo{
      width:44px; height:44px; border-radius:50%;
      background:
        radial-gradient(circle at 30% 30%, #ffffffaa, transparent 35%),
        radial-gradient(circle at 70% 60%, rgba(18,240,255,.9), transparent 50%),
        radial-gradient(circle at 30% 70%, rgba(138,125,255,.8), transparent 55%),
        linear-gradient(135deg, #0ee 0%, #3b7cff 50%, #7d6bff 100%);
      border:1px solid #ffffff22; box-shadow:0 0 25px rgba(18,240,255,.35);
    }
    h1{
      font-size:20px; margin:0; letter-spacing:.6px;
    }
    .sub{color:var(--muted); font-size:12px;}
    main{padding:18px;}
    .grid{
      display:grid; gap:14px;
      grid-template-columns: 1.1fr .9fr;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr;}
    }
    .card{
      background:linear-gradient(180deg, var(--panel), var(--panel-2));
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:14px;
      box-shadow:var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .card::after{
      content:"";
      position:absolute; inset:-40% -20% auto auto; width:260px; height:260px;
      background: radial-gradient(circle, rgba(18,240,255,.12), transparent 60%);
      transform:rotate(12deg);
      pointer-events:none;
    }
    .titleRow{display:flex; align-items:center; justify-content:space-between;}
    .title{
      font-size:15px; letter-spacing:.5px; margin:0;
      display:flex; align-items:center; gap:8px;
    }
    .chip{
      background:var(--chip);
      border:1px solid var(--chip-b);
      padding:3px 8px; border-radius:999px; font-size:11px; color:var(--muted);
    }
    .row{display:flex; gap:10px; flex-wrap:wrap;}
    .col{flex:1; min-width:200px;}
    label{font-size:12px; color:var(--muted);}
    input, select, textarea{
      width:100%; margin-top:6px; padding:10px 10px;
      background:#070b1f; color:var(--text);
      border:1px solid var(--border-soft);
      border-radius:10px; outline:none;
    }
    textarea{min-height:76px; resize:vertical;}
    input:focus, select:focus, textarea:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 3px var(--accent-soft);
    }
    .btn{
      background:linear-gradient(90deg, #0ff, #7d6bff);
      color:#04101a; border:0; padding:10px 14px;
      border-radius:12px; cursor:pointer; font-weight:700;
      letter-spacing:.4px; box-shadow:0 6px 18px rgba(18,240,255,.25);
    }
    .btn.ghost{
      background:transparent; color:var(--text);
      border:1px solid var(--border-soft); font-weight:600;
      box-shadow:none;
    }
    .btn:active{transform:translateY(1px)}
    .kpis{
      display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-top:10px;
    }
    .kpi{
      background:#070b1f; border:1px solid var(--border);
      border-radius:12px; padding:10px;
    }
    .kpi .num{font-size:20px; font-weight:800;}
    .kpi .lbl{font-size:11px; color:var(--muted);}
    .status{
      font-size:12px; padding:3px 8px; border-radius:999px; font-weight:700;
      border:1px solid transparent;
    }
    .ok{color:var(--good); border-color:rgba(60,229,124,.35); background:rgba(60,229,124,.08);}
    .warn{color:var(--warn); border-color:rgba(255,200,87,.35); background:rgba(255,200,87,.08);}
    .bad{color:var(--bad); border-color:rgba(255,77,109,.35); background:rgba(255,77,109,.08);}
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px; color:#dfe6ff;
      white-space:pre-wrap; word-break:break-word;
      background:#070b1f; border:1px solid var(--border); border-radius:12px; padding:10px;
      max-height:280px; overflow:auto;
    }
    .divider{height:1px; background:var(--border); margin:12px 0;}
    .hint{font-size:12px; color:var(--muted);}
    .small{font-size:11px; color:var(--muted);}
  </style>
</head>
<body>

<header>
  <div class="wrap brand">
    <div class="logo" aria-hidden="true"></div>
    <div>
      <h1>Synaptics.Systems — AML / Anti-Terror Financing Core</h1>
      <div class="sub">Authority Discrepancy Anchoring • Vessel Drift Detection • Tamper-Evident Audit</div>
    </div>
    <nav aria-label="Synaptics navigation">
      <a href="index.html">Suite Hub</a>
      <a href="ComplianceCore.html">Compliance Core</a>
      <a href="ComplianceAuditCore.html">Audit Core</a>
      <a href="NDPS Genesis Core.html">NDSP Genesis</a>
      <a href="ServerFramework.html">Server Framework</a>
    </nav>
  </div>
</header>

<main class="wrap">
  <div class="grid">

    <!-- LEFT COLUMN -->
    <section class="card">
      <div class="titleRow">
        <h2 class="title">AML Operational Console <span class="chip">CORE</span></h2>
        <div id="coreHealth" class="status ok">ONLINE</div>
      </div>

      <div class="kpis">
        <div class="kpi">
          <div class="num" id="kpiUsers">0</div>
          <div class="lbl">Users Evaluated</div>
        </div>
        <div class="kpi">
          <div class="num" id="kpiTxns">0</div>
          <div class="lbl">Transactions Evaluated</div>
        </div>
        <div class="kpi">
          <div class="num" id="kpiFlags">0</div>
          <div class="lbl">Review / Blocks</div>
        </div>
      </div>

      <div class="divider"></div>

      <h3 class="title">User Risk Check <span class="chip">KYC/PEP/Sanctions</span></h3>
      <div class="row">
        <div class="col">
          <label>User ID</label>
          <input id="userId" value="u1" />
        </div>
        <div class="col">
          <label>KYC Verified</label>
          <select id="kycVerified">
            <option value="true">true</option>
            <option value="false" selected>false</option>
          </select>
        </div>
        <div class="col">
          <label>Geo Risk</label>
          <select id="geoRisk">
            <option>LOW</option>
            <option>MEDIUM</option>
            <option>HIGH</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:8px;">
        <div class="col">
          <label>PEP Match</label>
          <select id="pepMatch">
            <option value="false" selected>false</option>
            <option value="true">true</option>
          </select>
        </div>
        <div class="col">
          <label>Sanctions Match</label>
          <select id="sanctionsMatch">
            <option value="false" selected>false</option>
            <option value="true">true</option>
          </select>
        </div>
        <div class="col">
          <label>Intent</label>
          <select id="userIntent">
            <option>LOGIN</option>
            <option>DEPOSIT</option>
            <option selected>WITHDRAW</option>
            <option>TRANSFER</option>
          </select>
        </div>
      </div>

      <div style="margin-top:10px; display:flex; gap:8px;">
        <button class="btn" id="runUser">Run User Check</button>
        <button class="btn ghost" id="clearUser">Reset</button>
      </div>

      <div style="margin-top:10px;">
        <div class="mono" id="userOut">Awaiting user evaluation…</div>
      </div>

      <div class="divider"></div>

      <h3 class="title">Transaction Risk Check <span class="chip">Rules + Context</span></h3>

      <div class="row">
        <div class="col">
          <label>Transaction ID</label>
          <input id="txnId" value="t1" />
        </div>
        <div class="col">
          <label>Amount (fiat eq.)</label>
          <input id="txnAmount" type="number" value="12000" />
        </div>
        <div class="col">
          <label>Asset Type</label>
          <select id="assetType">
            <option>NORMAL</option>
            <option>UNHOSTED_WALLET</option>
            <option>PRIVACY_COIN</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:8px;">
        <div class="col">
          <label>Velocity High</label>
          <select id="velHigh">
            <option value="false" selected>false</option>
            <option value="true">true</option>
          </select>
        </div>
        <div class="col">
          <label>Structuring Pattern</label>
          <select id="structuring">
            <option value="false" selected>false</option>
            <option value="true">true</option>
          </select>
        </div>
        <div class="col">
          <label>Mixer Exposure</label>
          <select id="mixerExp">
            <option value="false" selected>false</option>
            <option value="true">true</option>
          </select>
        </div>
      </div>

      <div style="margin-top:10px; display:flex; gap:8px;">
        <button class="btn" id="runTxn">Run Transaction Check</button>
        <button class="btn ghost" id="clearTxn">Reset</button>
      </div>

      <div style="margin-top:10px;">
        <div class="mono" id="txnOut">Awaiting transaction evaluation…</div>
      </div>
    </section>

    <!-- RIGHT COLUMN -->
    <section class="card">
      <div class="titleRow">
        <h2 class="title">Anchoring + Discrepancy Layer <span class="chip">AUTHORITY / VESSEL</span></h2>
        <div id="discrepBadge" class="status warn">NO ACTIONS YET</div>
      </div>

      <h3 class="title" style="margin-top:10px;">Authority Confirmation Protocol</h3>
      <div class="hint">
        Multi-authority quorum for sensitive events. Conflicts produce discrepancy flags that feed AML scoring.
      </div>

      <div class="row" style="margin-top:8px;">
        <div class="col">
          <label>Sensitive Action Type</label>
          <select id="actionType">
            <option>LARGE_WITHDRAWAL_OVERRIDE</option>
            <option>MANUAL_UNFREEZE</option>
            <option>HIGH_RISK_ONBOARD</option>
          </select>
        </div>
        <div class="col">
          <label>Target User</label>
          <input id="actionUser" value="u1"/>
        </div>
      </div>

      <label style="margin-top:8px; display:block;">Action Meta (JSON)</label>
      <textarea id="actionMeta">{ "limit": 25000 }</textarea>

      <div style="margin-top:10px; display:flex; gap:8px;">
        <button class="btn" id="proposeAction">Propose Action</button>
        <button class="btn ghost" id="resolveAction">Resolve</button>
      </div>

      <div class="row" style="margin-top:8px;">
        <div class="col">
          <label>Authority ID</label>
          <select id="authId">
            <option>authA</option>
            <option>authB</option>
            <option>authC</option>
          </select>
        </div>
        <div class="col">
          <label>Decision</label>
          <select id="authDecision">
            <option>APPROVE</option>
            <option>REJECT</option>
          </select>
        </div>
      </div>

      <label style="margin-top:8px; display:block;">Decision Note</label>
      <input id="authNote" placeholder="note..." />

      <div style="margin-top:8px; display:flex; gap:8px;">
        <button class="btn" id="submitApproval">Submit Approval</button>
        <button class="btn ghost" id="clearAuth">Clear</button>
      </div>

      <div style="margin-top:10px;">
        <div class="mono" id="authOut">No pending action.</div>
      </div>

      <div class="divider"></div>

      <h3 class="title">Vessel Discrepancy Monitor</h3>
      <div class="hint">
        “Vessel” = any system boundary where state might drift (server, shard, cache, client ledger).
      </div>

      <div class="row" style="margin-top:8px;">
        <div class="col">
          <label>Vessel ID</label>
          <input id="vesselId" value="api-1"/>
        </div>
        <div class="col">
          <label>State JSON</label>
          <input id="vesselState" value='{ "ledgerTip":"abc", "balances":{"u1":100} }'/>
        </div>
      </div>

      <div style="margin-top:8px; display:flex; gap:8px;">
        <button class="btn" id="heartbeat">Heartbeat</button>
        <button class="btn ghost" id="clearVessel">Reset</button>
      </div>

      <div style="margin-top:10px;">
        <div class="mono" id="vesselOut">No vessel heartbeats yet.</div>
      </div>

      <div class="divider"></div>

      <h3 class="title">Audit Chain Viewer</h3>
      <div class="small">Hash-chained events. If a log entry is changed, chain verify fails.</div>

      <div style="margin-top:8px; display:flex; gap:8px;">
        <button class="btn ghost" id="refreshAudit">Refresh Audit</button>
        <button class="btn ghost" id="verifyAudit">Verify</button>
      </div>

      <div style="margin-top:10px;">
        <div class="mono" id="auditOut">Audit ready.</div>
      </div>
    </section>
  </div>
</main>

<script>
/* =========================
   SYNAPTICS AML CORE (JS)
   ========================= */

// --- utils ---
function sha256(input){
  const str = typeof input === "string" ? input : JSON.stringify(input);
  let h = 0;
  for (let i=0;i<str.length;i++) h = (h<<5)-h + str.charCodeAt(i) | 0;
  return `weak-${Math.abs(h)}`;
}
const nowISO = () => new Date().toISOString();

class AuditChain {
  constructor({chainId="AML-AUDIT", salt=""}={}){
    this.chainId=chainId; this.salt=salt; this.events=[];
    this.tip=sha256({chainId,salt,genesis:true});
  }
  append(event){
    const record={
      id:sha256({event,prev:this.tip,t:nowISO(),salt:this.salt}),
      t:nowISO(), prev:this.tip, chainId:this.chainId, event
    };
    this.events.push(record); this.tip=record.id; return record;
  }
  verify(){
    let prev=sha256({chainId:this.chainId,salt:this.salt,genesis:true});
    for(const r of this.events){
      const expected=sha256({event:r.event,prev,t:r.t,salt:this.salt});
      if(expected!==r.id) return false; prev=r.id;
    }
    return true;
  }
  export(){ return {chainId:this.chainId, tip:this.tip, events:[...this.events]}; }
}

class RulesEngine {
  constructor({rules=[]}={}){ this.rules=rules.slice(); }
  addRule(rule){
    if(!rule?.id || typeof rule.evaluate!=="function") throw new Error("Invalid rule");
    this.rules.push(rule);
  }
  evaluate(ctx){
    const hits=[];
    for(const r of this.rules){
      const res=r.evaluate(ctx);
      if(res?.hit) hits.push({id:r.id,...res});
    }
    return hits;
  }
}

class RiskScorer {
  constructor({weights={}}={}){
    this.weights={
      kycIncomplete:30, pepMatch:40, sanctionsMatch:100, highRiskGeo:25,
      txnVelocity:20, structuringPattern:35, mixerExposure:50,
      vesselDiscrepancy:60, authorityDiscrepancy:60, manualFlag:50,
      ...weights
    };
  }
  scoreUser(user){
    let score=0; const reasons=[];
    if(!user.kyc?.verified){ score+=this.weights.kycIncomplete; reasons.push("KYC_INCOMPLETE"); }
    if(user.matches?.pep){ score+=this.weights.pepMatch; reasons.push("PEP_MATCH"); }
    if(user.matches?.sanctions){ score+=this.weights.sanctionsMatch; reasons.push("SANCTIONS_MATCH"); }
    if(user.geo?.riskLevel==="HIGH"){ score+=this.weights.highRiskGeo; reasons.push("HIGH_RISK_GEO"); }
    if(user.flags?.manual){ score+=this.weights.manualFlag; reasons.push("MANUAL_FLAG"); }
    return {score,reasons};
  }
  scoreTransaction(txn, ctx={}){
    let score=0; const reasons=[];
    if(ctx.velocity?.isHigh){ score+=this.weights.txnVelocity; reasons.push("TXN_VELOCITY_HIGH"); }
    if(ctx.patterns?.structuring){ score+=this.weights.structuringPattern; reasons.push("STRUCTURING_PATTERN"); }
    if(ctx.exposure?.mixer){ score+=this.weights.mixerExposure; reasons.push("MIXER_EXPOSURE"); }
    if(ctx.vessel?.discrepancy){ score+=this.weights.vesselDiscrepancy; reasons.push("VESSEL_DISCREPANCY"); }
    if(ctx.authority?.discrepancy){ score+=this.weights.authorityDiscrepancy; reasons.push("AUTHORITY_DISCREPANCY"); }
    return {score,reasons};
  }
}

class AuthorityAnchors {
  constructor({quorum=2, authorities=[], audit}={}){
    this.quorum=quorum;
    this.authorities=new Map(authorities.map(a=>[a.id,{...a}]));
    this.audit=audit||new AuditChain({chainId:"AML-AUTH"});
    this.pending=new Map();
  }
  proposeAction(action){
    const actionId=sha256({action,t:nowISO()});
    this.pending.set(actionId,{actionId,action,approvals:new Map(),createdAt:nowISO()});
    this.audit.append({type:"ACTION_PROPOSED",actionId,action});
    return actionId;
  }
  approve(actionId, authorityId, decision, meta={}){
    const pending=this.pending.get(actionId);
    const auth=this.authorities.get(authorityId);
    if(!pending) throw new Error("Unknown actionId");
    if(!auth || !auth.active) throw new Error("Inactive/unknown authority");
    if(!["APPROVE","REJECT"].includes(decision)) throw new Error("Bad decision");

    const approvalRecord={
      authorityId,decision,meta,t:nowISO(),
      anchor:sha256({actionId,authorityId,decision,meta,prev:this.audit.tip})
    };
    pending.approvals.set(authorityId,approvalRecord);
    this.audit.append({type:"ACTION_APPROVAL",actionId,approvalRecord});
    return approvalRecord;
  }
  resolve(actionId){
    const pending=this.pending.get(actionId);
    if(!pending) throw new Error("Unknown actionId");
    const approvals=[...pending.approvals.values()];
    const approves=approvals.filter(a=>a.decision==="APPROVE");
    const rejects=approvals.filter(a=>a.decision==="REJECT");
    const discrepancy=rejects.length>0 && approves.length>0;
    const quorumMet=approves.length>=this.quorum;
    const rejected=rejects.length>=this.quorum;
    const status=rejected?"REJECTED":quorumMet?"APPROVED":"PENDING";
    const resolution={actionId,status,discrepancy,approves:approves.length,rejects:rejects.length,quorum:this.quorum};
    this.audit.append({type:"ACTION_RESOLVED",resolution});
    if(status!=="PENDING") this.pending.delete(actionId);
    return resolution;
  }
}

class VesselMonitor {
  constructor({audit}={}){
    this.audit=audit||new AuditChain({chainId:"AML-VESSEL"});
    this.vessels=new Map();
  }
  heartbeat(vesselId,state,meta={}){
    const stateHash=sha256(state);
    const prev=this.vessels.get(vesselId);
    const discrepancy=prev && prev.lastHash!==stateHash;
    const record={vesselId,stateHash,discrepancy,prevHash:prev?.lastHash||null,t:nowISO(),meta};
    this.vessels.set(vesselId,{lastHash:stateHash,lastSeen:record.t,meta});
    this.audit.append({type:"VESSEL_HEARTBEAT",record});
    return record;
  }
}

class AMLCore {
  constructor({rules=[],riskWeights={},authorities=[],authorityQuorum=2}={}){
    this.audit=new AuditChain({chainId:"AML-CORE"});
    this.rules=new RulesEngine({rules});
    this.scorer=new RiskScorer({weights:riskWeights});
    this.authority=new AuthorityAnchors({
      quorum:authorityQuorum, authorities,
      audit:new AuditChain({chainId:"AML-AUTH"})
    });
    this.vessel=new VesselMonitor({audit:new AuditChain({chainId:"AML-VESSEL"})});
    this.thresholds={userReview:40, txnReview:50, txnBlock:80};
  }
  evaluateUser(user,ctx={}){
    const ruleHits=this.rules.evaluate({kind:"USER",userProfile:user,ctx});
    const {score,reasons}=this.scorer.scoreUser(user);
    const risk=score + ruleHits.reduce((s,h)=>s+(h.weight||0),0);
    const disposition=risk>=this.thresholds.userReview?"REVIEW":"PASS";
    const result={risk,reasons,ruleHits,disposition};
    this.audit.append({type:"USER_EVALUATED",userId:user.id,result});
    return result;
  }
  evaluateTransaction(txn,ctx={}){
    const ruleHits=this.rules.evaluate({kind:"TXN",txn,ctx});
    const {score,reasons}=this.scorer.scoreTransaction(txn,ctx);
    const risk=score + ruleHits.reduce((s,h)=>s+(h.weight||0),0);
    const disposition=risk>=this.thresholds.txnBlock?"BLOCK":risk>=this.thresholds.txnReview?"REVIEW":"PASS";
    const result={risk,reasons,ruleHits,disposition};
    this.audit.append({type:"TXN_EVALUATED",txnId:txn.id,result});
    return result;
  }
}

const DefaultRules=[
  {
    id:"RULE_LARGE_TXN_REVIEW",
    evaluate({kind,txn}){
      if(kind!=="TXN") return {hit:false};
      const amt=Number(txn.amount||0);
      return amt>=10000?{hit:true,weight:25,reason:"LARGE_TXN"}:{hit:false};
    }
  },
  {
    id:"RULE_HIGH_RISK_ASSET",
    evaluate({kind,txn}){
      if(kind!=="TXN") return {hit:false};
      return ["PRIVACY_COIN","UNHOSTED_WALLET"].includes(txn.assetType)
        ? {hit:true,weight:20,reason:"HIGH_RISK_ASSET"}
        : {hit:false};
    }
  },
  {
    id:"RULE_KYC_REQUIRED_FOR_WITHDRAW",
    evaluate({kind,userProfile,ctx}){
      if(kind!=="USER") return {hit:false};
      if(ctx.intent==="WITHDRAW" && !userProfile.kyc?.verified){
        return {hit:true,weight:35,reason:"KYC_REQUIRED"};
      }
      return {hit:false};
    }
  }
];

// =========================
// UI WIRING
// =========================
const aml = new AMLCore({
  rules: DefaultRules,
  authorityQuorum: 2,
  authorities: [
    { id:"authA", role:"COMPLIANCE_OFFICER", active:true },
    { id:"authB", role:"RISK_OFFICER", active:true },
    { id:"authC", role:"SECURITY", active:true }
  ]
});

let stats = { users:0, txns:0, flags:0 };
let currentActionId = null;
let lastAuthorityDiscrepancy = false;
let lastVesselDiscrepancy = false;

const $ = (id)=>document.getElementById(id);
function pretty(obj){ return JSON.stringify(obj,null,2); }
function bumpKPIs(){
  $("kpiUsers").textContent = stats.users;
  $("kpiTxns").textContent = stats.txns;
  $("kpiFlags").textContent = stats.flags;
}

// User check
$("runUser").onclick = ()=>{
  const user = {
    id: $("userId").value.trim(),
    kyc: { verified: $("kycVerified").value==="true" },
    matches: {
      pep: $("pepMatch").value==="true",
      sanctions: $("sanctionsMatch").value==="true"
    },
    geo: { riskLevel: $("geoRisk").value },
    flags: {}
  };
  const ctx = { intent: $("userIntent").value };
  const res = aml.evaluateUser(user, ctx);

  stats.users++;
  if(res.disposition!=="PASS") stats.flags++;
  bumpKPIs();

  $("userOut").textContent = pretty(res);
};

// reset
$("clearUser").onclick = ()=>{
  $("userId").value="u1";
  $("kycVerified").value="false";
  $("geoRisk").value="LOW";
  $("pepMatch").value="false";
  $("sanctionsMatch").value="false";
  $("userIntent").value="WITHDRAW";
  $("userOut").textContent="Awaiting user evaluation…";
};

// Transaction check
$("runTxn").onclick = ()=>{
  const txn = {
    id: $("txnId").value.trim(),
    userId: $("userId").value.trim(),
    amount: Number($("txnAmount").value||0),
    assetType: $("assetType").value
  };
  const ctx = {
    velocity:{ isHigh: $("velHigh").value==="true" },
    patterns:{ structuring: $("structuring").value==="true" },
    exposure:{ mixer: $("mixerExp").value==="true" },
    vessel:{ discrepancy: lastVesselDiscrepancy },
    authority:{ discrepancy: lastAuthorityDiscrepancy }
  };
  const res = aml.evaluateTransaction(txn, ctx);

  stats.txns++;
  if(res.disposition!=="PASS") stats.flags++;
  bumpKPIs();

  $("txnOut").textContent = pretty(res);
};

$("clearTxn").onclick = ()=>{
  $("txnId").value="t1";
  $("txnAmount").value="12000";
  $("assetType").value="UNHOSTED_WALLET";
  $("velHigh").value="false";
  $("structuring").value="false";
  $("mixerExp").value="false";
  $("txnOut").textContent="Awaiting transaction evaluation…";
};

// Authority protocol
$("proposeAction").onclick = ()=>{
  let meta = {};
  try{ meta = JSON.parse($("actionMeta").value||"{}"); }catch{}
  const action = {
    type: $("actionType").value,
    userId: $("actionUser").value.trim(),
    meta
  };
  currentActionId = aml.authority.proposeAction(action);
  lastAuthorityDiscrepancy = false;
  $("discrepBadge").className="status warn";
  $("discrepBadge").textContent="PENDING ACTION";
  $("authOut").textContent = "Action proposed:\n" + currentActionId + "\n\n" + pretty(action);
};

$("submitApproval").onclick = ()=>{
  if(!currentActionId){
    $("authOut").textContent="No pending action. Propose one first.";
    return;
  }
  const authId = $("authId").value;
  const decision = $("authDecision").value;
  const note = $("authNote").value.trim();

  try{
    const rec = aml.authority.approve(currentActionId, authId, decision, {note});
    const pending = aml.authority.pending.get(currentActionId);
    const approvals = [...pending.approvals.values()];
    $("authOut").textContent =
      "Approval recorded:\n" + pretty(rec) +
      "\n\nCurrent approvals:\n" + pretty(approvals);
  }catch(e){
    $("authOut").textContent="Error: " + e.message;
  }
};

$("resolveAction").onclick = ()=>{
  if(!currentActionId){
    $("authOut").textContent="No pending action.";
    return;
  }
  const res = aml.authority.resolve(currentActionId);
  lastAuthorityDiscrepancy = res.discrepancy;

  if(res.discrepancy){
    $("discrepBadge").className="status bad";
    $("discrepBadge").textContent="AUTHORITY DISCREPANCY";
  }else{
    $("discrepBadge").className="status ok";
    $("discrepBadge").textContent="AUTHORITY CONSENSUS";
  }
  $("authOut").textContent = "Resolution:\n" + pretty(res);
  if(res.status!=="PENDING") currentActionId=null;
};

$("clearAuth").onclick = ()=>{
  currentActionId=null;
  lastAuthorityDiscrepancy=false;
  $("authNote").value="";
  $("authOut").textContent="No pending action.";
  $("discrepBadge").className="status warn";
  $("discrepBadge").textContent="NO ACTIONS YET";
};

// Vessel monitor
$("heartbeat").onclick = ()=>{
  const vesselId = $("vesselId").value.trim();
  let state = {};
  try{ state = JSON.parse($("vesselState").value||"{}"); }catch{}
  const rec = aml.vessel.heartbeat(vesselId, state);
  lastVesselDiscrepancy = rec.discrepancy;

  $("vesselOut").textContent =
    "Heartbeat recorded:\n" + pretty(rec) +
    "\n\nVessel drift contributes to AML risk scoring.";
};

$("clearVessel").onclick = ()=>{
  $("vesselId").value="api-1";
  $("vesselState").value='{ "ledgerTip":"abc", "balances":{"u1":100} }';
  $("vesselOut").textContent="No vessel heartbeats yet.";
  lastVesselDiscrepancy=false;
};

// Audit viewer
function refreshAudit(){
  const bundle = {
    core: aml.audit.export(),
    authority: aml.authority.audit.export(),
    vessel: aml.vessel.audit.export()
  };
  $("auditOut").textContent = pretty(bundle);
}
$("refreshAudit").onclick = refreshAudit;

$("verifyAudit").onclick = ()=>{
  const ok = {
    core: aml.audit.verify(),
    authority: aml.authority.audit.verify(),
    vessel: aml.vessel.audit.verify()
  };
  $("auditOut").textContent = "Audit verification:\n" + pretty(ok);
};

refreshAudit();
</script>

</body>
</html>
